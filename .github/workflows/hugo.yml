name: Build and Deploy to COS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Cache Node Modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.OS }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-

    - name: Install Hugo
      run: |
        wget https://github.com/gohugoio/hugo/releases/download/v0.152.2/hugo_extended_0.152.2_linux-amd64.deb
        sudo dpkg -i hugo*.deb
        hugo version

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: |
        rm -rf public
        npm run build
        echo 'Build done!'

    - name: Install COSCLI
      run: |
        # Download COSCLI for Linux from official source
        # Use official download URL: https://cosbrowser.cloud.tencent.com/software/coscli/coscli-linux
        wget -q --tries=3 --timeout=30 https://cosbrowser.cloud.tencent.com/software/coscli/coscli-linux -O coscli
        if [ ! -f coscli ]; then
          echo "Failed to download COSCLI"
          exit 1
        fi
        chmod +x coscli
        sudo mv coscli /usr/local/bin/
        coscli --version

    - name: Deploy to Tencent COS using COSCLI
      env:
        TENCENT_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}
        TENCENT_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}
        CDN_DOMAIN: alili.tech
      run: |
        # Configure COSCLI config file
        # According to: https://cloud.tencent.com/document/product/436/63143
        # Bucket: serverless-page-bucket-5z6gco4t-1257581837
        # Region: ap-shanghai, Endpoint: cos.ap-shanghai.myqcloud.com
        cat > ~/.cos.yaml << EOF
        cos:
          base:
            secretid: ${{ secrets.TCB_SECRET_ID }}
            secretkey: ${{ secrets.TCB_SECRET_KEY }}
            sessiontoken: ""
            protocol: https
          buckets:
            - name: serverless-page-bucket-5z6gco4t-1257581837
              alias: default
              region: ap-shanghai
              endpoint: cos.ap-shanghai.myqcloud.com
        EOF
        
        # Direct sync with optimized parameters for faster upload
        # Upload contents of public/ directory to root of COS bucket (not the public/ directory itself)
        # Note: Compression upload would require server-side extraction (not supported by COS directly)
        # For static website hosting, direct sync is the most reliable method
        # Optimizations:
        # - --thread-num 20: Increased concurrent threads (default: 5)
        # - --part-size 32: Larger chunk size for better performance (default: 32MB)
        # - --recursive: Recursively sync all files
        echo "Syncing public directory contents to COS root..."
        # Upload contents of public/ directory to root of COS bucket (not the public/ directory itself)
        # Verify public directory exists
        if [ ! -d "./public" ]; then
          echo "Error: public directory not found"
          ls -la
          exit 1
        fi
        echo "Public directory contents:"
        ls -la ./public | head -20
        # Use cp command with -r flag to copy directory contents
        # The trailing slash in destination ensures contents go to root, not public/ subdirectory
        coscli cp ./public/ cos://serverless-page-bucket-5z6gco4t-1257581837/ \
          -r \
          --thread-num 20 \
          --part-size 32
        
        # Refresh CDN cache after upload
        echo "Refreshing CDN cache..."
        CDN_DOMAIN="alili.tech" node refresh-cdn.js || echo "CDN cache refresh skipped or failed"
